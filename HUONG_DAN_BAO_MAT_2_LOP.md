# üîê H∆Ø·ªöNG D·∫™N TRI·ªÇN KHAI B·∫¢O M·∫¨T 2 L·ªöP

## T·ªïng Quan

T√†i li·ªáu n√†y h∆∞·ªõng d·∫´n c√°ch tri·ªÉn khai **m√¥ h√¨nh b·∫£o m·∫≠t 2 l·ªõp** cho h·ªá th·ªëng qu·∫£n l√Ω nh√¢n s·ª±, n∆°i m·ªói t√†i kho·∫£n ng∆∞·ªùi d√πng c√≥:

1. **L·ªõp Application**: B·∫£n ghi trong b·∫£ng `NguoiDung`
2. **L·ªõp Database**: SQL Server Login + Database User + Role Membership

## üèóÔ∏è Ki·∫øn Tr√∫c H·ªá Th·ªëng

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           NG∆Ø·ªúI D√ôNG ƒêƒÇNG NH·∫¨P                      ‚îÇ
‚îÇ       (Username: nhanvien01, Password: ****)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         L·ªöP 1: X√ÅC TH·ª∞C SQL SERVER                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ SQL Server Login Authentication             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Ki·ªÉm tra Login t·ªìn t·∫°i                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - X√°c th·ª±c m·∫≠t kh·∫©u                        ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Login disabled/enabled?                   ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ ‚úì ƒêƒÉng nh·∫≠p th√†nh c√¥ng
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         L·ªöP 2: PH√ÇN QUY·ªÄN APPLICATION               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ Database User & Role Membership             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Ki·ªÉm tra b·∫£ng NguoiDung                   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Ki·ªÉm tra KichHoat = 1                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - L·∫•y VaiTro (HR/QuanLy/KeToan/NhanVien)   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - √Åp d·ª•ng quy·ªÅn theo Role                   ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    T·∫§T C·∫¢ TRUY V·∫§N CH·∫†Y V·ªöI QUY·ªÄN C·ª¶A USER          ‚îÇ
‚îÇ         (Connection String ƒë·ªông)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìã PH·∫¶N 1: PH√çA SQL SERVER

### B∆∞·ªõc 1: Ch·∫°y Script T·∫°o Stored Procedures

File: `04_StoredProcedures_Advanced.sql` (ƒë√£ ƒë∆∞·ª£c b·ªï sung)

C√°c stored procedures m·ªõi:

#### 1.1. `sp_TaoTaiKhoanDayDu` - T·∫°o T√†i Kho·∫£n Ho√†n Ch·ªânh

```sql
EXEC dbo.sp_TaoTaiKhoanDayDu
    @HoTen = N'Nguy·ªÖn VƒÉn A',
    @NgaySinh = '1990-01-15',
    @GioiTinh = N'Nam',
    @DienThoai = '0912345678',
    @Email = 'nguyenvana@company.com',
    @DiaChi = N'123 ƒê∆∞·ªùng ABC, TP.HCM',
    @NgayVaoLam = '2024-01-01',
    @MaPhongBan = 1,
    @MaChucVu = 2,
    @LuongCoBan = 10000000,
    @TenDangNhap = 'nhanvien01',
    @MatKhau = 'Pass@123',  -- M·∫≠t kh·∫©u g·ªëc
    @VaiTro = N'NhanVien',
    @MaNV_OUT = NULL;
```

**Thao t√°c th·ª±c hi·ªán:**
1. T·∫°o b·∫£n ghi trong `NguoiDung` v·ªõi hash SHA2_256
2. T·∫°o b·∫£n ghi trong `NhanVien`
3. T·∫°o SQL Server Login: `CREATE LOGIN [nhanvien01] WITH PASSWORD = 'Pass@123'`
4. T·∫°o Database User: `CREATE USER [nhanvien01] FOR LOGIN [nhanvien01]`
5. Th√™m v√†o Role: `ALTER ROLE r_nhanvien ADD MEMBER [nhanvien01]`

#### 1.2. `sp_CapNhatTaiKhoanDayDu` - C·∫≠p Nh·∫≠t T√†i Kho·∫£n

```sql
EXEC dbo.sp_CapNhatTaiKhoanDayDu
    @MaNV = 10,
    @HoTen = N'Nguy·ªÖn VƒÉn A (Updated)',
    @NgaySinh = '1990-01-15',
    @GioiTinh = N'Nam',
    @DienThoai = '0912345678',
    @Email = 'nguyenvana@company.com',
    @DiaChi = N'456 ƒê∆∞·ªùng XYZ, TP.HCM',
    @MaPhongBan = 2,
    @MaChucVu = 3,
    @LuongCoBan = 12000000,
    @VaiTro = N'QuanLy',  -- ƒê·ªïi vai tr√≤ t·ª´ NhanVien -> QuanLy
    @MatKhauMoi = 'NewPass@456';  -- ƒê·ªïi m·∫≠t kh·∫©u (ho·∫∑c NULL n·∫øu kh√¥ng ƒë·ªïi)
```

**Thao t√°c th·ª±c hi·ªán:**
1. C·∫≠p nh·∫≠t b·∫£ng `NhanVien` v√† `NguoiDung`
2. N·∫øu c√≥ `@MatKhauMoi`: `ALTER LOGIN [nhanvien01] WITH PASSWORD = 'NewPass@456'`
3. N·∫øu ƒë·ªïi vai tr√≤:
   - X√≥a kh·ªèi Role c≈©: `ALTER ROLE r_nhanvien DROP MEMBER [nhanvien01]`
   - Th√™m v√†o Role m·ªõi: `ALTER ROLE r_quanly ADD MEMBER [nhanvien01]`

#### 1.3. `sp_XoaTaiKhoanDayDu` - X√≥a T√†i Kho·∫£n Ho√†n To√†n

```sql
EXEC dbo.sp_XoaTaiKhoanDayDu @MaNV = 10;
```

**Thao t√°c th·ª±c hi·ªán:**
1. X√≥a Database User: `DROP USER [nhanvien01]`
2. X√≥a SQL Login: `DROP LOGIN [nhanvien01]`
3. X√≥a b·∫£n ghi trong `NhanVien` v√† `NguoiDung`

#### 1.4. `sp_VoHieuHoaTaiKhoan` - V√¥ Hi·ªáu H√≥a/K√≠ch Ho·∫°t

```sql
-- V√¥ hi·ªáu h√≥a t√†i kho·∫£n
EXEC dbo.sp_VoHieuHoaTaiKhoan @MaNV = 10, @KichHoat = 0;

-- K√≠ch ho·∫°t l·∫°i t√†i kho·∫£n
EXEC dbo.sp_VoHieuHoaTaiKhoan @MaNV = 10, @KichHoat = 1;
```

**Thao t√°c th·ª±c hi·ªán:**
1. C·∫≠p nh·∫≠t `NguoiDung.KichHoat`
2. `ALTER LOGIN [nhanvien01] ENABLE/DISABLE`

---

## üíª PH·∫¶N 2: PH√çA ·ª®NG D·ª§NG WINFORMS

### B∆∞·ªõc 2: C√°c Class ƒê√£ ƒê∆∞·ª£c T·∫°o

#### 2.1. `GlobalState.cs` - L∆∞u Tr·ªØ Chu·ªói K·∫øt N·ªëi ƒê·ªông

```csharp
public static class GlobalState
{
    public static string ConnectionString { get; set; }
    public static string ServerName { get; set; } = "localhost";
    public static string DatabaseName { get; set; } = "QLNhanSuSieuThiMini";
    
    public static void Clear() { ... }
    public static bool HasConnection() { ... }
}
```

#### 2.2. `frmLogin.cs` - ƒêƒÉng Nh·∫≠p v·ªõi X√°c Th·ª±c ƒê·ªông

**Lu·ªìng ƒëƒÉng nh·∫≠p m·ªõi:**

```csharp
private void btnLogin_Click(object sender, EventArgs e)
{
    string username = txtUsername.Text.Trim();
    string password = txtPassword.Text;
    
    // T·∫†O CHU·ªñI K·∫æT N·ªêI ƒê·ªòNG
    SqlConnectionStringBuilder builder = new SqlConnectionStringBuilder();
    builder.DataSource = GlobalState.ServerName;
    builder.InitialCatalog = GlobalState.DatabaseName;
    builder.UserID = username;  // ‚Üê S·ª≠ d·ª•ng username ng∆∞·ªùi d√πng nh·∫≠p
    builder.Password = password;  // ‚Üê S·ª≠ d·ª•ng password ng∆∞·ªùi d√πng nh·∫≠p
    builder.TrustServerCertificate = true;
    
    string dynamicConnectionString = builder.ConnectionString;
    
    using (SqlConnection conn = new SqlConnection(dynamicConnectionString))
    {
        try
        {
            conn.Open();  // ‚Üê N·∫øu th√†nh c√¥ng = SQL Login h·ª£p l·ªá
            
            // L·∫•y th√¥ng tin t·ª´ b·∫£ng NguoiDung
            string query = @"SELECT nd.MaNguoiDung, nd.VaiTro, nd.KichHoat, 
                                    nv.MaNV, nv.HoTen 
                             FROM dbo.NguoiDung nd
                             LEFT JOIN dbo.NhanVien nv ON nd.MaNguoiDung = nv.MaNguoiDung
                             WHERE nd.TenDangNhap = @username";
            
            SqlCommand cmd = new SqlCommand(query, conn);
            cmd.Parameters.AddWithValue("@username", username);
            SqlDataReader reader = cmd.ExecuteReader();
            
            if (reader.Read())
            {
                bool kichHoat = reader.GetBoolean(2);
                if (!kichHoat)
                {
                    MessageBox.Show("T√†i kho·∫£n ƒë√£ b·ªã kh√≥a.");
                    return;
                }
                
                // L∆ØU CHU·ªñI K·∫æT N·ªêI V√ÄO GLOBALSTATE
                GlobalState.ConnectionString = dynamicConnectionString;
                
                // L∆∞u th√¥ng tin user
                UserSession.SetUser(maNguoiDung, maNV, username, hoTen, vaiTro);
                
                // M·ªü form ch√≠nh
                frmMain mainForm = new frmMain(vaiTro);
                this.Hide();
                mainForm.ShowDialog();
                this.Close();
            }
        }
        catch (SqlException ex)
        {
            if (ex.Number == 18456)  // Login failed
            {
                MessageBox.Show("T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.");
            }
        }
    }
}
```

### B∆∞·ªõc 3: C·∫≠p Nh·∫≠t C√°c Form Kh√°c

**T·∫§T C·∫¢ c√°c form kh√°c c·∫ßn ƒë·ªïi t·ª´:**

```csharp
// C≈®: ƒê·ªçc t·ª´ App.config
string connectionString = ConfigurationManager.ConnectionStrings["HrDb"].ConnectionString;
```

**Th√†nh:**

```csharp
// M·ªöI: ƒê·ªçc t·ª´ GlobalState
string connectionString = GlobalState.ConnectionString;
```

**V√≠ d·ª• trong `frmNhanVien.cs`:**

```csharp
private void LoadData()
{
    // Thay v√¨ ƒë·ªçc t·ª´ App.config
    // string connString = ConfigurationManager.ConnectionStrings["HrDb"].ConnectionString;
    
    // D√πng chu·ªói k·∫øt n·ªëi ƒë·ªông
    string connString = GlobalState.ConnectionString;
    
    using (SqlConnection conn = new SqlConnection(connString))
    {
        // ... code nh∆∞ c≈©
    }
}
```

---

## üîÑ PH·∫¶N 3: QUY TR√åNH S·ª¨ D·ª§NG

### 3.1. T·∫°o T√†i Kho·∫£n M·ªõi

**Trong SQL Server Management Studio:**

```sql
DECLARE @MaNV INT;

EXEC dbo.sp_TaoTaiKhoanDayDu
    @HoTen = N'Tr·∫ßn Th·ªã B',
    @NgaySinh = '1995-06-20',
    @GioiTinh = N'Nu',
    @DienThoai = '0987654321',
    @Email = 'tranthib@company.com',
    @DiaChi = N'789 ƒê∆∞·ªùng DEF, H√† N·ªôi',
    @NgayVaoLam = '2024-06-01',
    @MaPhongBan = 2,
    @MaChucVu = 1,
    @LuongCoBan = 8000000,
    @TenDangNhap = 'hr_tranthib',
    @MatKhau = 'HR@2024',
    @VaiTro = N'HR',
    @MaNV_OUT = @MaNV OUTPUT;

SELECT @MaNV AS MaNhanVienMoi;
```

**K·∫øt qu·∫£:**
- T·∫°o Login: `hr_tranthib` v·ªõi password `HR@2024`
- T·∫°o User: `hr_tranthib` trong database `QLNhanSuSieuThiMini`
- Th√™m v√†o Role: `r_hr`
- Ng∆∞·ªùi d√πng c√≥ th·ªÉ ƒëƒÉng nh·∫≠p v√†o ·ª©ng d·ª•ng v·ªõi username `hr_tranthib` v√† password `HR@2024`

### 3.2. ƒêƒÉng Nh·∫≠p V√†o ·ª®ng D·ª•ng

1. M·ªü ·ª©ng d·ª•ng WinForms
2. Nh·∫≠p:
   - **Username:** `hr_tranthib`
   - **Password:** `HR@2024`
3. Click **ƒêƒÉng nh·∫≠p**

**ƒêi·ªÅu g√¨ x·∫£y ra:**
- ·ª®ng d·ª•ng t·∫°o chu·ªói k·∫øt n·ªëi v·ªõi `UserID=hr_tranthib, Password=HR@2024`
- SQL Server x√°c th·ª±c Login
- ·ª®ng d·ª•ng ki·ªÉm tra b·∫£ng `NguoiDung` ‚Üí l·∫•y vai tr√≤ `HR`
- L∆∞u chu·ªói k·∫øt n·ªëi v√†o `GlobalState.ConnectionString`
- M·ªü `frmMain` v·ªõi quy·ªÅn HR

### 3.3. ƒê·ªïi M·∫≠t Kh·∫©u

```sql
EXEC dbo.sp_CapNhatTaiKhoanDayDu
    @MaNV = 15,
    @HoTen = N'Tr·∫ßn Th·ªã B',
    @NgaySinh = '1995-06-20',
    @GioiTinh = N'Nu',
    @DienThoai = '0987654321',
    @Email = 'tranthib@company.com',
    @DiaChi = N'789 ƒê∆∞·ªùng DEF, H√† N·ªôi',
    @MaPhongBan = 2,
    @MaChucVu = 1,
    @LuongCoBan = 8000000,
    @VaiTro = N'HR',
    @MatKhauMoi = 'NewHR@2025';  -- ‚Üê M·∫≠t kh·∫©u m·ªõi
```

L·∫ßn sau ƒëƒÉng nh·∫≠p ph·∫£i d√πng password m·ªõi: `NewHR@2025`

### 3.4. Kh√≥a/M·ªü Kh√≥a T√†i Kho·∫£n

```sql
-- Kh√≥a t√†i kho·∫£n (kh√¥ng cho ƒëƒÉng nh·∫≠p)
EXEC dbo.sp_VoHieuHoaTaiKhoan @MaNV = 15, @KichHoat = 0;

-- K√≠ch ho·∫°t l·∫°i
EXEC dbo.sp_VoHieuHoaTaiKhoan @MaNV = 15, @KichHoat = 1;
```

Khi t√†i kho·∫£n b·ªã kh√≥a:
- SQL Login b·ªã `DISABLE`
- Ng∆∞·ªùi d√πng kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p v√†o SQL Server
- N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p r·ªìi, s·∫Ω b·ªã ch·∫∑n khi ki·ªÉm tra `NguoiDung.KichHoat = 0`

---

## üõ°Ô∏è PH·∫¶N 4: B·∫¢O M·∫¨T & ∆ØU ƒêI·ªÇM

### ∆Øu ƒêi·ªÉm c·ªßa M√¥ H√¨nh 2 L·ªõp

#### 1. **Audit Trail T·ª± ƒê·ªông**
M·ªói thao t√°c trong database ƒë·ªÅu ghi nh·∫≠n ƒë√∫ng ng∆∞·ªùi th·ª±c hi·ªán:
```sql
SELECT 
    SUSER_SNAME() AS CurrentLoginName,  -- T√™n SQL Login
    USER_NAME() AS CurrentDatabaseUser   -- T√™n Database User
```

#### 2. **Ph√¢n Quy·ªÅn Ch·∫∑t Ch·∫Ω**
- M·ªói ng∆∞·ªùi d√πng ch·ªâ c√≥ quy·ªÅn theo Role c·ªßa m√¨nh
- Kh√¥ng c·∫ßn ki·ªÉm tra quy·ªÅn trong code C#
- SQL Server t·ª± ƒë·ªông ch·∫∑n truy c·∫≠p tr√°i ph√©p

#### 3. **Kh√¥ng L∆∞u M·∫≠t Kh·∫©u sa trong App.config**
- File `App.config` ch·ªâ ch·ª©a t√™n server v√† database
- Kh√¥ng c√≥ th√¥ng tin nh·∫°y c·∫£m
- M·ªói session c√≥ chu·ªói k·∫øt n·ªëi ri√™ng

#### 4. **Kh·∫£ NƒÉng Audit & Compliance**
- C√≥ th·ªÉ b·∫≠t `SQL Server Audit` ƒë·ªÉ ghi log t·∫•t c·∫£ thao t√°c
- Bi·∫øt ch√≠nh x√°c ai ƒë√£ l√†m g√¨, khi n√†o
- ƒê√°p ·ª©ng y√™u c·∫ßu ISO 27001, SOC 2

### B·∫£o M·∫≠t N√¢ng Cao

#### 1. Encryption at Rest
C√≥ th·ªÉ b·∫≠t TDE (Transparent Data Encryption) ƒë·ªÉ m√£ h√≥a d·ªØ li·ªáu tr√™n ƒëƒ©a.

#### 2. Encryption in Transit
S·ª≠ d·ª•ng SSL/TLS cho k·∫øt n·ªëi SQL Server:
```csharp
builder.Encrypt = true;
builder.TrustServerCertificate = false;  // Trong m√¥i tr∆∞·ªùng production
```

#### 3. Row-Level Security
C√≥ th·ªÉ th√™m RLS ƒë·ªÉ ng∆∞·ªùi d√πng ch·ªâ th·∫•y d·ªØ li·ªáu c·ªßa ch√≠nh h·ªç:
```sql
CREATE SECURITY POLICY NhanVien_Policy
ADD FILTER PREDICATE dbo.fn_FilterNhanVien(MaNV)
ON dbo.NhanVien;
```

---

## ‚ö†Ô∏è PH·∫¶N 5: L∆ØU √ù & GI·∫¢I QUY·∫æT S·ª∞ C·ªê

### L∆∞u √ù Quan Tr·ªçng

1. **M·∫≠t kh·∫©u ph·∫£i ƒë·ªß m·∫°nh:**
   - √çt nh·∫•t 8 k√Ω t·ª±
   - C√≥ ch·ªØ hoa, ch·ªØ th∆∞·ªùng, s·ªë, k√Ω t·ª± ƒë·∫∑c bi·ªát
   - V√≠ d·ª•: `Pass@123`, `HR@2024`

2. **T√†i kho·∫£n sa v·∫´n c·∫ßn thi·∫øt:**
   - Ch·ªâ d√πng ƒë·ªÉ ch·∫°y c√°c script kh·ªüi t·∫°o/b·∫£o tr√¨
   - Kh√¥ng d√πng trong ·ª©ng d·ª•ng th∆∞·ªùng ng√†y

3. **Backup ƒë·ªãnh k·ª≥:**
   - Backup c·∫£ database l·∫´n master database (ch·ª©a Login)
   - Script backup Login:
   ```sql
   SELECT 'CREATE LOGIN ' + QUOTENAME(name) + ' WITH PASSWORD_HASH = ' + 
          sys.fn_varbintohexstr(password_hash) + ' HASHED;'
   FROM sys.sql_logins
   WHERE name LIKE '%nhanvien%' OR name LIKE '%hr_%';
   ```

### X·ª≠ L√Ω S·ª± C·ªë

#### S·ª± c·ªë 1: Qu√™n M·∫≠t Kh·∫©u

**Gi·∫£i ph√°p:** D√πng t√†i kho·∫£n sa ƒë·ªÉ reset:

```sql
-- K·∫øt n·ªëi b·∫±ng sa
ALTER LOGIN [nhanvien01] WITH PASSWORD = 'TempPass@123';

-- Th√¥ng b√°o cho user m·∫≠t kh·∫©u t·∫°m
-- User ƒëƒÉng nh·∫≠p v√† ƒë·ªïi l·∫°i m·∫≠t kh·∫©u m·ªõi
```

#### S·ª± c·ªë 2: Login B·ªã Kh√≥a Nh·∫ßm

```sql
-- Ki·ªÉm tra tr·∫°ng th√°i
SELECT name, is_disabled FROM sys.server_principals WHERE name = 'nhanvien01';

-- M·ªü kh√≥a
ALTER LOGIN [nhanvien01] ENABLE;
```

#### S·ª± c·ªë 3: Orphaned User (User kh√¥ng c√≥ Login)

```sql
-- Ki·ªÉm tra
SELECT dp.name AS UserName, sp.name AS LoginName
FROM sys.database_principals dp
LEFT JOIN sys.server_principals sp ON dp.sid = sp.sid
WHERE dp.type = 'S' AND sp.name IS NULL;

-- S·ª≠a
ALTER USER [nhanvien01] WITH LOGIN = [nhanvien01];
```

#### S·ª± c·ªë 4: Kh√¥ng Th·ªÉ ƒêƒÉng Nh·∫≠p

**Checklist:**
1. ‚úÖ SQL Server Authentication ƒë√£ b·∫≠t ch∆∞a?
   ```sql
   -- Ki·ªÉm tra
   SELECT SERVERPROPERTY('IsIntegratedSecurityOnly');
   -- N·∫øu = 1 ‚Üí ch·ªâ Windows Auth
   -- C·∫ßn chuy·ªÉn sang Mixed Mode
   ```

2. ‚úÖ Login t·ªìn t·∫°i kh√¥ng?
   ```sql
   SELECT name, is_disabled FROM sys.server_principals WHERE name = 'nhanvien01';
   ```

3. ‚úÖ Database User t·ªìn t·∫°i kh√¥ng?
   ```sql
   SELECT name FROM sys.database_principals WHERE name = 'nhanvien01';
   ```

4. ‚úÖ User c√≥ trong Role kh√¥ng?
   ```sql
   SELECT USER_NAME(member_principal_id) AS UserName,
          USER_NAME(role_principal_id) AS RoleName
   FROM sys.database_role_members
   WHERE USER_NAME(member_principal_id) = 'nhanvien01';
   ```

---

## üìä PH·∫¶N 6: KI·ªÇM TRA & GI√ÅM S√ÅT

### Ki·ªÉm Tra T√†i Kho·∫£n Hi·ªán T·∫°i

```sql
-- Li·ªát k√™ t·∫•t c·∫£ Login ƒë√£ t·∫°o
SELECT 
    sp.name AS LoginName,
    sp.type_desc AS LoginType,
    sp.is_disabled AS IsDisabled,
    sp.create_date AS CreateDate,
    sp.modify_date AS LastModified
FROM sys.server_principals sp
WHERE sp.type = 'S'  -- SQL Authentication
  AND sp.name NOT LIKE '##%'  -- Lo·∫°i b·ªè system accounts
ORDER BY sp.name;

-- Li·ªát k√™ User v√† Role
SELECT 
    dp.name AS UserName,
    STRING_AGG(drm.role_principal_id, ',') AS RoleIDs,
    STRING_AGG(USER_NAME(drm.role_principal_id), ', ') AS RoleNames
FROM sys.database_principals dp
LEFT JOIN sys.database_role_members drm ON dp.principal_id = drm.member_principal_id
WHERE dp.type = 'S'
GROUP BY dp.name
ORDER BY dp.name;

-- Li·ªát k√™ quy·ªÅn c·ªßa t·ª´ng User
SELECT 
    dp.name AS UserName,
    o.name AS ObjectName,
    p.permission_name,
    p.state_desc
FROM sys.database_permissions p
JOIN sys.database_principals dp ON p.grantee_principal_id = dp.principal_id
LEFT JOIN sys.objects o ON p.major_id = o.object_id
WHERE dp.type = 'S'
ORDER BY dp.name, o.name;
```

### Gi√°m S√°t Ho·∫°t ƒê·ªông

```sql
-- Xem ai ƒëang connect
SELECT 
    session_id,
    login_name,
    host_name,
    program_name,
    login_time,
    last_request_start_time
FROM sys.dm_exec_sessions
WHERE is_user_process = 1
  AND database_id = DB_ID('QLNhanSuSieuThiMini')
ORDER BY login_time DESC;

-- Xem c√¢u l·ªánh ƒëang ch·∫°y
SELECT 
    s.session_id,
    s.login_name,
    t.text AS QueryText,
    s.status,
    s.cpu_time,
    s.total_elapsed_time
FROM sys.dm_exec_sessions s
CROSS APPLY sys.dm_exec_sql_text(s.most_recent_sql_handle) t
WHERE s.is_user_process = 1
  AND s.database_id = DB_ID('QLNhanSuSieuThiMini');
```

---

## üéØ PH·∫¶N 7: K·∫æT LU·∫¨N

### T√≥m T·∫Øt Quy Tr√¨nh

1. **Kh·ªüi t·∫°o:**
   - Ch·∫°y script SQL t·∫°o stored procedures
   - Th√™m `GlobalState.cs` v√† `UserSession.cs` v√†o project
   - C·∫≠p nh·∫≠t `frmLogin.cs`

2. **T·∫°o t√†i kho·∫£n:**
   - D√πng `sp_TaoTaiKhoanDayDu` ƒë·ªÉ t·∫°o t√†i kho·∫£n m·ªõi
   - Th√¥ng b√°o username/password cho nh√¢n vi√™n

3. **S·ª≠ d·ª•ng:**
   - Nh√¢n vi√™n ƒëƒÉng nh·∫≠p b·∫±ng username/password c·ªßa h·ªç
   - M·ªói thao t√°c trong database ghi nh·∫≠n ƒë√∫ng ng∆∞·ªùi th·ª±c hi·ªán
   - Quy·ªÅn h·∫°n ƒë∆∞·ª£c ki·ªÉm so√°t t·ª± ƒë·ªông b·ªüi SQL Server

4. **B·∫£o tr√¨:**
   - D√πng `sp_CapNhatTaiKhoanDayDu` ƒë·ªÉ ƒë·ªïi th√¥ng tin/m·∫≠t kh·∫©u/vai tr√≤
   - D√πng `sp_VoHieuHoaTaiKhoan` ƒë·ªÉ kh√≥a/m·ªü kh√≥a
   - D√πng `sp_XoaTaiKhoanDayDu` ƒë·ªÉ x√≥a t√†i kho·∫£n

### L·ª£i √çch ƒê·∫°t ƒê∆∞·ª£c

‚úÖ **B·∫£o m·∫≠t:** M·ªói ng∆∞·ªùi d√πng c√≥ credential ri√™ng, kh√¥ng share account  
‚úÖ **Audit:** Bi·∫øt ch√≠nh x√°c ai l√†m g√¨, khi n√†o  
‚úÖ **Ph√¢n quy·ªÅn:** T·ª± ƒë·ªông theo Role, kh√¥ng c·∫ßn code ki·ªÉm tra ph·ª©c t·∫°p  
‚úÖ **Compliance:** ƒê√°p ·ª©ng y√™u c·∫ßu ISO 27001, SOC 2, GDPR  
‚úÖ **Kh√¥i ph·ª•c:** D·ªÖ d√†ng trace v√† rollback khi c√≥ s·ª± c·ªë  

### T√†i Li·ªáu Tham Kh·∫£o

- Microsoft Docs: SQL Server Security
- Microsoft Docs: Row-Level Security
- Microsoft Docs: Dynamic Data Masking
- OWASP: Database Security Cheat Sheet

---

**T√°c gi·∫£:** V≈© To√†n Th·∫Øng - 23110329  
**D·ª± √°n:** H·ªá Th·ªëng Qu·∫£n L√Ω Nh√¢n S·ª± Si√™u Th·ªã Mini  
**Ng√†y c·∫≠p nh·∫≠t:** 02/10/2025
